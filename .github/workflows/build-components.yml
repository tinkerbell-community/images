name: Build Components

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to build"
        required: true
        type: choice
        options:
          - kernel
          - overlay
          - installer          - rpi
          - arm64
          - amd64
          - images          - rpi
          - arm64
          - amd64
          - images
          - all
  push:
    branches:
      - main
    paths:
      - "Pkgfile"
      - "config/**.yaml"
      - "patches/**"
  schedule:
    # Run weekly to rebuild components
    - cron: "0 4 * * 0"

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  # Detect which components need building based on file changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      pkgfile: ${{ steps.filter.outputs.pkgfile }}
      kernel: ${{ steps.filter.outputs.kernel }}
      overlay: ${{ steps.filter.outputs.overlay }}
      installer: ${{ steps.filter.outputs.installer }}
      build-kernel: ${{ steps.decide.outputs.build-kernel }}
      build-overlay: ${{ steps.decide.outputs.build-overlay }}
      build-installer: ${{ steps.decide.outputs.build-installer }}
      build-rpi: ${{ steps.decide.outputs.build-rpi }}
      build-arm64: ${{ steps.decide.outputs.build-arm64 }}
      build-amd64: ${{ steps.decide.outputs.build-amd64 }}
      build-rpi: ${{ steps.decide.outputs.build-rpi }}
      build-arm64: ${{ steps.decide.outputs.build-arm64 }}
      build-amd64: ${{ steps.decide.outputs.build-amd64 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            pkgfile:
              - Pkgfile
            kernel:
              - config/kernel.yaml
              - patches/**
            overlay:
              - config/overlay.yaml
            installer:
              - config/installer.yaml

      - name: Decide what to build
        id: decide
        run: |
          # Manual trigger or scheduled - respect target input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            target="${{ github.event.inputs.target }}"
            # Component builds
            if [ "$target" == "all" ] || [ "$target" == "kernel" ]; then
              echo "build-kernel=true" >> $GITHUB_OUTPUT
            else
              echo "build-kernel=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "$target" == "all" ] || [ "$target" == "overlay" ]; then
              echo "build-overlay=true" >> $GITHUB_OUTPUT
            else
              echo "build-overlay=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "$target" == "all" ] || [ "$target" == "installer" ] || [ "$target" == "rpi" ] || [ "$target" == "arm64" ] || [ "$target" == "amd64" ] || [ "$target" == "images" ]; then
              echo "build-installer=true" >> $GITHUB_OUTPUT
            else
              echo "build-installer=false" >> $GITHUB_OUTPUT
            fi
            
            # Machine image builds
            if [ "$target" == "all" ] || [ "$target" == "rpi" ] || [ "$target" == "images" ]; then
              echo "build-rpi=true" >> $GITHUB_OUTPUT
            else
              echo "build-rpi=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "$target" == "all" ] || [ "$target" == "arm64" ] || [ "$target" == "images" ]; then
              echo "build-arm64=true" >> $GITHUB_OUTPUT
            else
              echo "build-arm64=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "$target" == "all" ] || [ "$target" == "amd64" ] || [ "$target" == "images" ]; then
              echo "build-amd64=true" >> $GITHUB_OUTPUT
            else
              echo "build-amd64=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            # Scheduled builds - build everything
            echo "build-kernel=true" >> $GITHUB_OUTPUT
            echo "build-overlay=true" >> $GITHUB_OUTPUT
            echo "build-installer=true" >> $GITHUB_OUTPUT
            echo "build-rpi=true" >> $GITHUB_OUTPUT
            echo "build-arm64=true" >> $GITHUB_OUTPUT
            echo "build-amd64=true" >> $GITHUB_OUTPUT
          else
            # Push event - build based on dependency chain
            pkgfile="${{ steps.filter.outputs.pkgfile }}"
            kernel="${{ steps.filter.outputs.kernel }}"
            overlay="${{ steps.filter.outputs.overlay }}"
            installer="${{ steps.filter.outputs.installer }}"
            
            # Dependency chain: 
            # RPi-specific: kernel -> overlay -> installer -> rpi image
            # Generic: installer -> arm64/amd64 images
            # 
            # If Pkgfile changes, rebuild everything (version change)
            # If kernel changes, rebuild kernel, overlay, installer, rpi image only
            # If overlay changes, rebuild overlay, installer, rpi image only
            # If installer changes, rebuild installer and all images
            
            if [ "$pkgfile" == "true" ] || [ "$kernel" == "true" ]; then
              echo "build-kernel=true" >> $GITHUB_OUTPUT
              echo "build-overlay=true" >> $GITHUB_OUTPUT
              echo "build-installer=true" >> $GITHUB_OUTPUT
              echo "build-rpi=true" >> $GITHUB_OUTPUT
              echo "build-arm64=true" >> $GITHUB_OUTPUT
              echo "build-amd64=true" >> $GITHUB_OUTPUT
            elif [ "$overlay" == "true" ]; then
              echo "build-kernel=false" >> $GITHUB_OUTPUT
              echo "build-overlay=true" >> $GITHUB_OUTPUT
              echo "build-installer=true" >> $GITHUB_OUTPUT
              echo "build-rpi=true" >> $GITHUB_OUTPUT
              echo "build-arm64=false" >> $GITHUB_OUTPUT
              echo "build-amd64=false" >> $GITHUB_OUTPUT
            elif [ "$installer" == "true" ]; then
              echo "build-kernel=false" >> $GITHUB_OUTPUT
              echo "build-overlay=false" >> $GITHUB_OUTPUT
              echo "build-installer=true" >> $GITHUB_OUTPUT
              echo "build-rpi=true" >> $GITHUB_OUTPUT
              echo "build-arm64=true" >> $GITHUB_OUTPUT
              echo "build-amd64=true" >> $GITHUB_OUTPUT
            else
              # No relevant changes
              echo "build-kernel=false" >> $GITHUB_OUTPUT
              echo "build-overlay=false" >> $GITHUB_OUTPUT
              echo "build-installer=false" >> $GITHUB_OUTPUT
              echo "build-rpi=false" >> $GITHUB_OUTPUT
              echo "build-arm64=false" >> $GITHUB_OUTPUT
              echo "build-amd64=false" >> $GITHUB_OUTPUT
            fi
          fi
          fi

  # Build kernel
  build-kernel:
    runs-on: ubuntu-24.04-arm
    needs: detect-changes
    if: needs.detect-changes.outputs.build-kernel == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Maximize build space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:v0.17.3
          buildkitd-flags: --allow-insecure-entitlement network.host --allow-insecure-entitlement security.insecure
          buildkitd-config: .github/buildkitd.toml

      - name: Configure kernel build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
          key: kernel-arm64-${{ hashFiles('Pkgfile', 'config/kernel.yaml', 'patches/**') }}
          restore-keys: |
            kernel-arm64-

      - name: Configure Docker layer cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-kernel-arm64-${{ hashFiles('Pkgfile') }}
          restore-keys: |
            buildx-kernel-arm64-

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get configuration
        id: config
        run: |
          pkgs_version=$(yq '.pkgs_version' Pkgfile)
          registry=$(grep "^REGISTRY" Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')
          username=$(grep "^REGISTRY_USERNAME" Makefile | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')

          echo "pkgs_version=$pkgs_version" >> $GITHUB_OUTPUT
          echo "registry=${registry:-ghcr.io}" >> $GITHUB_OUTPUT
          echo "username=${username:-tinkerbell-community}" >> $GITHUB_OUTPUT

      - name: Set up ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache
          ccache --set-config=max_size=5G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build kernel
        id: build
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          make kernel \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain \
            CI_ARGS="--cache-from=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/kernel:buildcache \
                     --cache-to=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/kernel:buildcache,mode=max \
                     --output=type=image,push=true,name=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/kernel:${{ steps.config.outputs.pkgs_version }} \
                     --shm-size=2g"

      - name: Show ccache statistics
        if: always()
        run: ccache --show-stats || true

      - name: Release kernel
        if: success()
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
        run: make release-kernel

  # Build overlay
  build-overlay:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-kernel]
    if: |
      always() &&
      needs.detect-changes.outputs.build-overlay == 'true' &&
      (needs.build-kernel.result == 'success' || needs.build-kernel.result == 'skipped')
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get configuration
        id: config
        run: |
          pkgs_version=$(yq '.pkgs_version' Pkgfile)
          overlay_version=$(yq '.overlay_version' Pkgfile)
          registry=$(grep "^REGISTRY" Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')
          username=$(grep "^REGISTRY_USERNAME" Makefile | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')

          echo "pkgs_version=$pkgs_version" >> $GITHUB_OUTPUT
          echo "overlay_version=$overlay_version" >> $GITHUB_OUTPUT
          echo "registry=${registry:-ghcr.io}" >> $GITHUB_OUTPUT
          echo "username=${username:-tinkerbell-community}" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build overlay
        id: build
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          make overlay \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain

      - name: Release overlay
        if: success()
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
        run: make release-overlay

  # Build installer
  build-installer:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-overlay]
    if: |
      always() &&
      needs.detect-changes.outputs.build-installer == 'true' &&
      (needs.build-overlay.result == 'success' || needs.build-overlay.result == 'skipped')
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          overlay_version=$(yq '.overlay_version' Pkgfile)
          registry=$(grep "^REGISTRY" Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')
          username=$(grep "^REGISTRY_USERNAME" Makefile | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')

          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT
          echo "overlay_version=$overlay_version" >> $GITHUB_OUTPUT
          echo "registry=${registry:-ghcr.io}" >> $GITHUB_OUTPUT
          echo "username=${username:-tinkerbell-community}" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build installer
        id: build
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          make installer \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain

      - name: Release installer
        if: success()
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
        run: make release-installer

      - name: Build summary
        if: success()
        env:
          TALOS_VERSION: ${{ steps.config.outputs.talos_version }}
        run: |
          echo "## Released Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Talos Version:** ${TALOS_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Kernel" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/tinkerbell-community/kernel:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overlay" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/tinkerbell-community/sbc-raspberrypi:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installer" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/tinkerbell-community/installer:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  # Build Raspberry Pi image
  build-image-rpi:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-rpi == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build Raspberry Pi image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make rpi

      - name: Upload Raspberry Pi image
        uses: actions/upload-artifact@v4
        with:
          name: talos-rpi-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error

  # Build generic ARM64 image
  build-image-arm64:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-arm64 == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build ARM64 image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make arm64

      - name: Upload ARM64 image
        uses: actions/upload-artifact@v4
        with:
          name: talos-arm64-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error

  # Build AMD64 image
  build-image-amd64:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-amd64 == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build AMD64 image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make amd64

      - name: Upload AMD64 image
        uses: actions/upload-artifact@v4
        with:
          name: talos-amd64-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error
  # Build Raspberry Pi image
  build-image-rpi:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-rpi == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build Raspberry Pi image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make rpi

      - name: Upload Raspberry Pi image
        uses: actions/upload-artifact@v4
        with:
          name: talos-rpi-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error

  # Build generic ARM64 image
  build-image-arm64:
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-arm64 == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build ARM64 image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make arm64

      - name: Upload ARM64 image
        uses: actions/upload-artifact@v4
        with:
          name: talos-arm64-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error

  # Build AMD64 image
  build-image-amd64:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-installer]
    if: |
      always() &&
      needs.detect-changes.outputs.build-amd64 == 'true' &&
      (needs.build-installer.result == 'success' || needs.build-installer.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get configuration
        id: config
        run: |
          talos_version=$(yq '.talos_version' Pkgfile)
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT

      - name: Set up vendor repositories
        run: make vendor-all

      - name: Build AMD64 image
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: make amd64

      - name: Upload AMD64 image
        uses: actions/upload-artifact@v4
        with:
          name: talos-amd64-${{ steps.config.outputs.talos_version }}
          path: _out/*.raw.zst
          if-no-files-found: error
