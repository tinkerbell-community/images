name: Build Components

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to build"
        required: true
        type: choice
        options:
          - kernel
          - overlay
          - installer
          - release
  push:
    branches:
      - main
    paths:
      - "config.yaml"
  schedule:
    # Run weekly to rebuild components
    - cron: "0 4 * * 0"

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  build-components:
    runs-on: ubuntu-24.04-arm
    if: github.event.inputs.target != 'release'
    steps:
      - name: Maximize build space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:v0.17.3
          buildkitd-flags: --allow-insecure-entitlement network.host --allow-insecure-entitlement security.insecure
          buildkitd-config: .github/buildkitd.toml

      - name: Configure kernel build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            vendor/pkgs/kernel/build
          key: kernel-arm64-${{ hashFiles('vendor/pkgs/Pkgfile', 'patches/**', 'config.yaml') }}
          restore-keys: |
            kernel-arm64-

      - name: Configure Docker layer cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-arm64-${{ hashFiles('vendor/pkgs/Pkgfile') }}
          restore-keys: |
            buildx-arm64-

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get configuration
        id: config
        run: |
          # Extract versions from Makefile
          pkgs_version=$(grep "^PKGS_VERSION" Makefile | cut -d'=' -f2 | tr -d ' ')
          talos_version=$(grep "^TALOS_VERSION" Makefile | cut -d'=' -f2 | tr -d ' ')
          overlay_version=$(grep "^SBCOVERLAY_VERSION" Makefile | cut -d'=' -f2 | tr -d ' ')
          registry=$(grep "^REGISTRY" Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')
          username=$(grep "^REGISTRY_USERNAME" Makefile | cut -d'=' -f2 | tr -d ' ' | sed 's/?//')

          echo "pkgs_version=$pkgs_version" >> $GITHUB_OUTPUT
          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT
          echo "overlay_version=$overlay_version" >> $GITHUB_OUTPUT
          echo "registry=${registry:-ghcr.io}" >> $GITHUB_OUTPUT
          echo "username=${username:-tinkerbell-community}" >> $GITHUB_OUTPUT

          echo "PKGS Version: $pkgs_version"
          echo "Talos Version: $talos_version"
          echo "Overlay Version: $overlay_version"

      - name: Set up ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache
          ccache --set-config=max_size=5G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV

      - name: Set up vendor repositories
        run: |
          make vendor-all

      - name: Build kernel
        if: github.event.inputs.target == '' || github.event.inputs.target == 'kernel'
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          echo "Building kernel with optimizations..."

          # Build with optimized arguments
          make kernel \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain \
            CI_ARGS="--cache-from=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/kernel:buildcache \
                     --cache-to=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/kernel:buildcache,mode=max \
                     --build-arg=MAKEFLAGS=-j$(nproc) \
                     --build-arg=CFLAGS='-O2 -pipe -fomit-frame-pointer' \
                     --build-arg=KBUILD_BUILD_TIMESTAMP=@$(shell git log -1 --pretty=%ct) \
                     --ulimit nofile=1024000:1024000 \
                     --shm-size=2g"

      - name: Build overlay
        if: github.event.inputs.target == '' || github.event.inputs.target == 'overlay' || github.event.inputs.target == 'installer'
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          echo "Building overlay with optimizations..."

          # Build with optimized arguments
          make overlay \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain \
            CI_ARGS="--cache-from=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/sbc-raspberrypi:buildcache \
                     --cache-to=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/sbc-raspberrypi:buildcache,mode=max \
                     --build-arg=MAKEFLAGS=-j$(nproc) \
                     --ulimit nofile=1024000:1024000 \
                     --shm-size=2g"

      - name: Build installer
        if: github.event.inputs.target == '' || github.event.inputs.target == 'installer'
        env:
          REGISTRY: ${{ steps.config.outputs.registry }}
          REGISTRY_USERNAME: ${{ steps.config.outputs.username }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
        run: |
          echo "Building installer with optimizations..."

          # Build with optimized arguments
          make installer \
            PLATFORM=linux/arm64 \
            PUSH=true \
            PROGRESS=plain \
            CI_ARGS="--cache-from=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/installer:buildcache \
                     --cache-to=type=registry,ref=${{ steps.config.outputs.registry }}/${{ steps.config.outputs.username }}/installer:buildcache,mode=max \
                     --build-arg=MAKEFLAGS=-j$(nproc) \
                     --ulimit nofile=1024000:1024000 \
                     --shm-size=2g"

      - name: Show ccache statistics
        if: always()
        run: |
          ccache --show-stats || true

      - name: Component summary
        env:
          TARGET: ${{ github.event.inputs.target }}
          PKGS_VERSION: ${{ steps.config.outputs.pkgs_version }}
          TALOS_VERSION: ${{ steps.config.outputs.talos_version }}
          OVERLAY_VERSION: ${{ steps.config.outputs.overlay_version }}
        run: |
          echo "## Built Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PKGS Version:** ${PKGS_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Talos Version:** ${TALOS_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Overlay Version:** ${OVERLAY_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show summary based on what was built
          if [ -z "${TARGET}" ] || [ "${TARGET}" == "kernel" ]; then
            echo "### Kernel Image" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.REGISTRY }}/${{ steps.config.outputs.username }}/kernel:${PKGS_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${TARGET}" ] || [ "${TARGET}" == "overlay" ] || [ "${TARGET}" == "installer" ]; then
            echo "### Overlay Image" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.REGISTRY }}/${{ steps.config.outputs.username }}/sbc-raspberrypi:${OVERLAY_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${TARGET}" ] || [ "${TARGET}" == "installer" ]; then
            echo "### Installer Image" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.REGISTRY }}/${{ steps.config.outputs.username }}/installer:${TALOS_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Imager Image" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ env.REGISTRY }}/${{ steps.config.outputs.username }}/imager:${TALOS_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'release' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get configuration
        id: config
        run: |
          talos_version=$(grep "^TALOS_VERSION" Makefile | cut -d'=' -f2 | tr -d ' ')
          tag="${GITHUB_REF#refs/tags/}"

          echo "talos_version=$talos_version" >> $GITHUB_OUTPUT
          echo "tag=$tag" >> $GITHUB_OUTPUT

          echo "Creating release: $tag"
          echo "  Talos Version: $talos_version"

      - name: Create release
        env:
          TAG: ${{ steps.config.outputs.tag }}
          REGISTRY: ${{ env.REGISTRY }}
          REGISTRY_USERNAME: tinkerbell-community
        run: |
          make release

      - name: Release summary
        env:
          TAG: ${{ steps.config.outputs.tag }}
          TALOS_VERSION: ${{ steps.config.outputs.talos_version }}
        run: |
          echo "## Released Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "**Based on Talos:** ${TALOS_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tagged Image" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/tinkerbell-community/installer:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
