name: Build and Push Talos Images

on:
  workflow_dispatch:
    inputs:
      talos_version:
        description: 'Talos version to build (e.g., v1.8.3)'
        required: false
        type: string
  schedule:
    # Run daily to check for new versions
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'talos-versions.json'
      - '.github/workflows/build-and-push.yml'

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [amd64, arm64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up ORAS
        uses: oras-project/setup-oras@v1
        with:
          version: 1.1.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Talos versions
        id: versions
        run: |
          if [ -n "${{ github.event.inputs.talos_version }}" ]; then
            echo "versions=[\"${{ github.event.inputs.talos_version }}\"]" >> $GITHUB_OUTPUT
          else
            versions=$(jq -r '.versions | @json' talos-versions.json)
            echo "versions=$versions" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Talos images
        env:
          VERSIONS: ${{ steps.versions.outputs.versions }}
          ARCH: ${{ matrix.architecture }}
        run: |
          set -e
          
          versions=$(echo "$VERSIONS" | jq -r '.[]')
          
          for version in $versions; do
            echo "Processing Talos version: $version for architecture: $ARCH"
            
            # Construct the download URL for Talos
            # Talos releases raw disk images for different platforms
            # Format: https://github.com/siderolabs/talos/releases/download/{version}/metal-{arch}.raw.xz
            download_url="https://github.com/siderolabs/talos/releases/download/${version}/metal-${ARCH}.raw.xz"
            
            # Download the image with retry logic
            echo "Downloading from: $download_url"
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if curl -L -f -o "talos-${version}-${ARCH}.raw.xz" "$download_url"; then
                echo "Successfully downloaded"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "Download failed, retrying ($retry_count/$max_retries)..."
                  sleep 5
                else
                  echo "Failed to download after $max_retries attempts, skipping..."
                  continue 2
                fi
              fi
            done
            
            # Construct the OCI image tag
            image_tag="${{ env.REGISTRY }}/${{ github.repository }}/talos-${ARCH}:${version}"
            
            # Push using ORAS
            echo "Pushing to: $image_tag"
            oras push "$image_tag" \
              --artifact-type application/vnd.talos.image.raw.xz \
              "talos-${version}-${ARCH}.raw.xz:application/vnd.talos.image.layer.v1+xz"
            
            # Also tag as latest for the most recent version
            if [ "$(echo "$VERSIONS" | jq -r '.[0]')" == "$version" ]; then
              latest_tag="${{ env.REGISTRY }}/${{ github.repository }}/talos-${ARCH}:latest"
              echo "Tagging as latest: $latest_tag"
              oras push "$latest_tag" \
                --artifact-type application/vnd.talos.image.raw.xz \
                "talos-${version}-${ARCH}.raw.xz:application/vnd.talos.image.layer.v1+xz"
            fi
            
            # Clean up
            rm -f "talos-${version}-${ARCH}.raw.xz"
            
            echo "Successfully pushed $image_tag"
          done

      - name: Image summary
        run: |
          echo "## Published Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images published to \`${{ env.REGISTRY }}/${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull images with:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "oras pull ${{ env.REGISTRY }}/${{ github.repository }}/talos-${{ matrix.architecture }}:<version>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
